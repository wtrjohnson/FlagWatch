<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlagWatch</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Georgia, serif;
      background: #fff;
      color: #000;
      text-align: center;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      padding: 20px 40px;
      font-weight: bold;
      font-size: 1.4rem;
      z-index: 10;
    }

    header img {
      height: 22px;
      margin-right: 10px;
    }

    /* SVG container holds the full skyline illustration */
    .svg-container {
      width: 100%;
      position: relative;
      z-index: 1;
      flex-grow: 1;
    }

    /* Let the SVG scale proportionally across the whole width */
    #skylineSVG {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Status footer */
    footer#statusText {
      font-size: 1.35rem;
      font-weight: bold;
      margin: 30px 0 40px 0;
      z-index: 20;
      padding: 0 10px;
    }

    footer#statusText em {
      color: #444;
    }

    /* State dropdown */
    .selectable-state {
      text-decoration: underline;
      cursor: pointer;
      font-weight: bold;
    }

    .state-dropdown {
      position: fixed;
      background: #fff;
      border: 2px solid #000;
      padding: 12px;
      width: 260px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 9999;
      font-family: Georgia, serif;
      font-size: 1.1rem;
      text-align: left;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .state-dropdown div {
      padding: 6px 4px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
    }

    .state-dropdown div:last-child {
      border-bottom: none;
    }

    .state-dropdown div:hover {
      background: #eee;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 800px) {
      footer#statusText {
        font-size: 1.1rem;
        margin-top: 20px;
      }
    }
  </style>
</head>

<body>

<header>
  <img src="FlagIcons/USAFlag.png" alt="Flag Icon">
  FlagWatch
</header>

<!-- Responsive SVG Skyline -->
<div class="svg-container">
  <object id="skylineSVG" data="FlagIcons/skyline.svg" type="image/svg+xml"></object>
</div>

<footer id="statusText"></footer>

<div id="stateDropdown" class="state-dropdown hidden"></div>

<script>
/* ---------------- State Map ---------------- */
const stateMapFull = {
  AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas",
  CA: "California", CO: "Colorado", CT: "Connecticut", DE: "Delaware",
  FL: "Florida", GA: "Georgia", HI: "Hawaii", ID: "Idaho", IL: "Illinois",
  IN: "Indiana", IA: "Iowa", KS: "Kansas", KY: "Kentucky", LA: "Louisiana",
  ME: "Maine", MD: "Maryland", MA: "Massachusetts", MI: "Michigan",
  MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
  NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey",
  NM: "New Mexico", NY: "New York", NC: "North Carolina", ND: "North Dakota",
  OH: "Ohio", OK: "Oklahoma", OR: "Oregon", PA: "Pennsylvania",
  RI: "Rhode Island", SC: "South Carolina", SD: "South Dakota",
  TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
  VA: "Virginia", WA: "Washington", WV: "West Virginia",
  WI: "Wisconsin", WY: "Wyoming", DC: "District of Columbia"
};

/* ---------------- Dropdown ---------------- */
const dropdown = document.getElementById("stateDropdown");
dropdown.innerHTML = Object.entries(stateMapFull)
  .map(([code, name]) => `<div data-code="${code}">${name}</div>`)
  .join("");

/* ---------------- Detect User State ---------------- */
async function detectUserState() {
  try {
    const res = await fetch("https://ipinfo.io/json?token=c0053c34b2bf22");
    const info = await res.json();

    if (info.region_code) return info.region_code.toUpperCase();

    const region = (info.region || "").toUpperCase();
    const found = Object.keys(stateMapFull).find(
      abbr => stateMapFull[abbr].toUpperCase() === region
    );
    return found || null;
  } catch {
    return null;
  }
}

/* ---------------- Main Flag Status Logic ---------------- */
async function loadFlagStatus(forcedState = null, svgDoc = null) {
  if (!svgDoc) return; // Wait for SVG to load

  const userState = await detectUserState();
  const state = (forcedState || userState || "VA").toUpperCase();

  const res = await fetch(`/.netlify/functions/getFlagStatus?state=${state}`);
  const data = await res.json();

  const national = data.find(r => r.state_code === null);
  const stateRow = data.find(r => (r.state_code || "").toUpperCase() === state);

  const usHalf = national?.half_mast;
  const stateHalf = stateRow?.half_mast;

  /* Access SVG elements */
  const flagUS = svgDoc.getElementById("FlagUS");
  const flagState = svgDoc.getElementById("FlagState");

  /* Update Images */
  flagUS.setAttribute("href", "FlagIcons/USAFlag.png");
  flagState.setAttribute("href", `FlagIcons/${state}Flag.png`);

  /* Apply Half-Mast (by adjusting y-position) */
  const FULL = 775;
  const HALF = 825;

  flagUS.setAttribute("y", usHalf ? HALF : FULL);
  flagState.setAttribute("y", stateHalf ? HALF : FULL);

  /* Update Text */
  const footer = document.getElementById("statusText");
  const stateName = stateMapFull[state];

  if (usHalf && stateHalf) {
    const reason = stateRow?.reason || national?.reason || "an active proclamation";
    footer.innerHTML =
      `United States and <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.`;
  } else if (!usHalf && stateHalf) {
    footer.innerHTML =
      `United States flags are not at half mast<br>
       <span class="selectable-state">${stateName}</span> flags are at half mast.`;
  } else if (usHalf && !stateHalf) {
    footer.innerHTML =
      `United States flags are at half mast<br>
       <span class="selectable-state">${stateName}</span> flags are not at half mast.`;
  } else {
    footer.innerHTML =
      `United States and <span class="selectable-state">${stateName}</span> flags are not at half mast.`;
  }
}

/* ---------------- Dropdown Interaction ---------------- */
document.addEventListener("click", (e) => {
  const isSelectable = e.target.classList.contains("selectable-state");

  if (isSelectable) {
    const rect = e.target.getBoundingClientRect();
    dropdown.classList.toggle("hidden");

    if (!dropdown.classList.contains("hidden")) {
      dropdown.style.top = rect.bottom + "px";
      dropdown.style.left = rect.left + "px";
    }
    return;
  }

  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

dropdown.addEventListener("click", (e) => {
  if (e.target.dataset.code && window.loadedSvgDoc) {
    dropdown.classList.add("hidden");
    loadFlagStatus(e.target.dataset.code, window.loadedSvgDoc);
  }
});

/* ---------------- SVG Initialization ---------------- */
document.getElementById("skylineSVG").addEventListener("load", () => {
  const svgDoc = document.getElementById("skylineSVG").contentDocument;
  window.loadedSvgDoc = svgDoc;
  loadFlagStatus(null, svgDoc);
});
</script>

</body>
</html>
