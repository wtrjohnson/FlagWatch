<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlagWatch</title>

<style>
/* ---------------- GLOBAL ---------------- */

body {
  font-family: "Georgia", serif;
  margin: 0;
  padding: 0;
  background: #fff;
  color: #000;
  text-align: center;
}

/* ---------------- HEADER ---------------- */

header {
  display: flex;
  align-items: center;
  padding: 20px 40px;
  font-weight: bold;
  font-size: 1.3rem;
}

header img {
  height: 22px;
  margin-right: 10px;
}

/* ---------------- SKYLINE SYSTEM (Option A) ---------------- */

.skyline-wrapper {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 80px;       /* headroom above skyline */
  position: relative;     /* anchor flags */
}

.skyline-img {
  width: 80%;             /* OPTION A width */
  height: auto;
  display: block;
}

/*
  The skyline image has ~58px of white padding below the ground line.
  We anchor the flagpoles so their bases sit *on the illustrated ground line*.
*/
.flag-container {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 58px;           /* <-- THIS anchors the pole bases to the ground line */
  display: flex;
  gap: 80px;
  pointer-events: none;
  z-index: 10;
}

/* ---------------- FLAG + POLE SYSTEM ---------------- */

.flag-pole {
  position: relative;
  width: 200px;
  height: 350px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  pointer-events: auto;
}

.flag-pole img.pole {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  height: 100%;
}

.flag-wrapper {
  position: absolute;
  top: 15px;              /* full-mast */
  left: 50%;
  transform: translateX(-50%);
  transition: top 2.2s ease-in-out;
  z-index: 20;
}

.flag-wrapper.half-mast {
  top: 80px;
}

.flag-wrapper img.flag {
  height: 150px;
  width: auto;
  object-fit: contain;
}

/* ---------------- FOOTER / STATUS TEXT ---------------- */

footer#statusText {
  font-size: 1.4rem;
  font-weight: bold;
  margin-top: 60px;      /* space below skyline */
  margin-bottom: 60px;
}

footer#statusText em {
  color: #444;
}

/* ---------------- DROPDOWN ---------------- */

.selectable-state {
  text-decoration: underline;
  cursor: pointer;
  font-weight: bold;
}

.state-dropdown {
  position: absolute;
  background: #fff;
  border: 2px solid #000;
  padding: 12px;
  width: 260px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999;
  font-family: Georgia, serif;
  font-size: 1.1rem;
  text-align: left;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.state-dropdown div {
  padding: 6px 4px;
  cursor: pointer;
  border-bottom: 1px solid #ccc;
}

.state-dropdown div:last-child {
  border-bottom: none;
}

.state-dropdown div:hover {
  background: #eee;
}

.hidden {
  display: none;
}

/* ---------------- RESPONSIVE ---------------- */

@media (max-width: 800px) {
  .skyline-img {
    width: 95%;
  }

  .flag-pole {
    width: 150px;
    height: 260px;
  }

  .flag-wrapper img.flag {
    height: 110px;
  }

  .flag-wrapper {
    top: 10px;
  }

  .flag-wrapper.half-mast {
    top: 60px;
  }

  footer#statusText {
    font-size: 1.1rem;
    margin-top: 40px;
    padding: 0 10px;
  }
}
</style>
</head>

<body>

<header>
  <img src="FlagIcons/USAFlag.png" alt="Flag Icon">
  FlagWatch
</header>

<!-- ================= SKYLINE IMAGE (Option A) ================= -->
<div class="skyline-wrapper">
  <img src="FlagIcons/skyline.png" class="skyline-img" alt="Skyline">

  <!-- ================= FLAGS ANCHORED TO GROUND LINE ================= -->
  <div class="flag-container">

    <!-- U.S. FLAG -->
    <div class="flag-pole">
      <img src="FlagIcons/FlagPole.png" class="pole" alt="U.S. Flagpole">
      <div class="flag-wrapper" id="us-wrapper">
        <img id="us-flag" class="flag" src="FlagIcons/USAFlag.png" alt="U.S. Flag">
      </div>
    </div>

    <!-- STATE FLAG -->
    <div class="flag-pole">
      <img src="FlagIcons/FlagPole.png" class="pole" alt="State Flagpole">
      <div class="flag-wrapper" id="state-wrapper">
        <img id="state-flag" class="flag" src="FlagIcons/VAFlag.png" alt="State Flag">
      </div>
    </div>

  </div>
</div>

<!-- ================= STATUS TEXT ================= -->
<footer id="statusText"></footer>

<!-- ================= DROPDOWN ================= -->
<div id="stateDropdown" class="state-dropdown hidden"></div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------------- State list ---------------- */
const stateMapFull = {
  AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas",
  CA: "California", CO: "Colorado", CT: "Connecticut", DE: "Delaware",
  FL: "Florida", GA: "Georgia", HI: "Hawaii", ID: "Idaho", IL: "Illinois",
  IN: "Indiana", IA: "Iowa", KS: "Kansas", KY: "Kentucky", LA: "Louisiana",
  ME: "Maine", MD: "Maryland", MA: "Massachusetts", MI: "Michigan",
  MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
  NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey",
  NM: "New Mexico", NY: "New York", NC: "North Carolina", ND: "North Dakota",
  OH: "Ohio", OK: "Oklahoma", OR: "Oregon", PA: "Pennsylvania",
  RI: "Rhode Island", SC: "South Carolina", SD: "South Dakota",
  TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
  VA: "Virginia", WA: "Washington", WV: "West Virginia",
  WI: "Wisconsin", WY: "Wyoming", DC: "District of Columbia"
};

/* Populate dropdown */
const dropdown = document.getElementById("stateDropdown");
dropdown.innerHTML = Object.entries(stateMapFull)
  .map(([code, name]) => `<div data-code="${code}">${name}</div>`)
  .join("");

/* Detect state */
async function detectUserState() {
  try {
    const res = await fetch("https://ipinfo.io/json?token=c0053c34b2bf22");
    const info = await res.json();

    if (info.region_code) return info.region_code.toUpperCase();

    const region = (info.region || "").toUpperCase();
    const found = Object.keys(stateMapFull).find(
      abbr => stateMapFull[abbr].toUpperCase() === region
    );
    return found || null;
  } catch {
    return null;
  }
}

/* Load status */
async function loadFlagStatus(forcedState = null) {
  const userState = await detectUserState();
  const state = (forcedState || userState || "VA").toUpperCase();

  const res = await fetch(`/.netlify/functions/getFlagStatus?state=${state}`);
  const data = await res.json();

  const national = data.find(r => r.state_code === null);
  const stateRow = data.find(r => (r.state_code || "").toUpperCase() === state);

  const usHalf = national?.half_mast;
  const stateHalf = stateRow?.half_mast;

  /* Apply images */
  document.getElementById("us-flag").src = "FlagIcons/USAFlag.png";
  document.getElementById("state-flag").src = `FlagIcons/${state}Flag.png`;

  /* Half-mast movement */
  document.getElementById("us-wrapper").classList.toggle("half-mast", usHalf);
  document.getElementById("state-wrapper").classList.toggle("half-mast", stateHalf);

  /* Update text */
  const footer = document.getElementById("statusText");
  const stateName = stateMapFull[state];

  if (usHalf && stateHalf) {
    const reason = stateRow?.reason || national?.reason || "an active proclamation";
    footer.innerHTML = `United States and <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.`;
  } else if (!usHalf && stateHalf) {
    footer.innerHTML = `
      United States flags are not at half mast<br>
      <span class="selectable-state">${stateName}</span> flags are at half mast.`;
  } else if (usHalf && !stateHalf) {
    footer.innerHTML = `
      United States flags are at half mast<br>
      <span class="selectable-state">${stateName}</span> flags are not at half mast.`;
  } else {
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are not at half mast.`;
  }
}

/* Dropdown logic */
document.addEventListener("click", (e) => {
  const isSelectable = e.target.classList.contains("selectable-state");

  if (isSelectable) {
    const rect = e.target.getBoundingClientRect();
    dropdown.classList.toggle("hidden");

    if (!dropdown.classList.contains("hidden")) {
      dropdown.style.top = rect.bottom + "px";
      dropdown.style.left = rect.left + "px";
    }

    return;
  }

  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

/* Choose state */
dropdown.addEventListener("click", (e) => {
  if (e.target.dataset.code) {
    dropdown.classList.add("hidden");
    loadFlagStatus(e.target.dataset.code);
  }
});

/* Init */
loadFlagStatus();
</script>

</body>
</html>
