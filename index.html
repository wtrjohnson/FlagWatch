<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flag Status</title>

<style>
body {
  font-family: "Georgia", serif;
  background-color: #fff;
  color: #000;
  text-align: center;
  margin: 0;
  padding: 0;
  background-image: url("FlagIcons/skyline.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center top;
  background-attachment: fixed;
}

header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 20px 40px;
  font-weight: bold;
  font-size: 1.2rem;
}

header img {
  height: 22px;
  margin-right: 8px;
}

/* CLEAN + RESET: main no longer pushes flags or text */
main {
  margin-top: 0;
  position: relative;
  width: 100%;
}

/* CLEAN + CORRECT FLAG POSITIONING */
.flag-container {
  position: absolute;
  top: 300px; /* ← ADJUST HERE to raise/lower poles */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 80px;
  background-color: transparent;
  z-index: 5;
  max-width: 100%;
  pointer-events: none;
}

.flag-pole {
  position: relative;
  width: 200px;
  height: 350px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  background-color: transparent;
  z-index: 1;
  pointer-events: auto;
}

.flag-wrapper {
  position: absolute;
  top: 15px;
  left: 15px;
  transition: top 2.2s ease-in-out;
  z-index: 2;
  pointer-events: auto;
}

.flag-wrapper.half-mast {
  top: 80px;
}

.flag-pole > img {
  max-height: 100%;
  object-fit: contain;
  width: auto;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}

.flag-wrapper img {
  height: 150px;
  width: auto;
  object-fit: contain;
  position: relative;
  z-index: 2;
  left: 0;
}

/* CLICKABLE STATE TEXT */
.selectable-state {
  text-decoration: underline;
  cursor: pointer;
  font-weight: bold;
  position: relative;
  z-index: 10;
}

/* DROPDOWN MENU */
.state-dropdown {
  position: absolute;
  background: #fff;
  border: 2px solid #000;
  padding: 12px;
  width: 260px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999;
  font-family: Georgia, serif;
  font-size: 1.1rem;
  line-height: 1.6;
  text-align: left;
  pointer-events: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.state-dropdown div {
  padding: 6px 4px;
  cursor: pointer;
  border-bottom: 1px solid #ccc;
}

.state-dropdown div:last-child {
  border-bottom: none;
}

.state-dropdown div:hover {
  background-color: #eee;
}

.hidden {
  display: none;
}

/* CLEAN SEPARATE MESSAGE POSITIONING */
footer#statusText {
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
  margin-top: 670px; /* ← ADJUST HERE to move message independently */
  padding-bottom: 40px;
  position: relative;
  z-index: 10;
}

footer em {
  font-style: italic;
  color: #444;
}

/* RESPONSIVE */
@media (max-width: 800px) {
  .flag-container {
    top: -60px;
    gap: 20px;
  }

  .flag-pole {
    width: 150px;
    height: 260px;
  }

  .flag-wrapper img {
    height: 110px;
  }

  .flag-wrapper {
    top: 10px;
    left: 10px;
  }

  .flag-wrapper.half-mast {
    top: 60px;
  }

  footer#statusText {
    margin-top: 180px;
    font-size: 1.1rem;
    padding: 0 10px;
  }
}
</style>
</head>
<body>

<header>
  <img src="/FlagIcons/USAFlag.png" alt="Flag Icon" />
  Flag Status
</header>

<main>
  <div class="flag-container">
    <div class="flag-pole">
      <img id="us-pole" src="/FlagIcons/FlagPole.png" alt="U.S. Flagpole" />
      <div class="flag-wrapper">
        <img id="us-flag" src="/FlagIcons/USAFlag.png" alt="U.S. Flag" />
      </div>
    </div>

    <div class="flag-pole">
      <img id="state-pole" src="/FlagIcons/FlagPole.png" alt="State Flagpole" />
      <div class="flag-wrapper">
        <img id="state-flag" src="/FlagIcons/VAFlag.png" alt="State Flag" />
      </div>
    </div>
  </div>

  <footer id="statusText"></footer>

  <div id="stateDropdown" class="state-dropdown hidden"></div>
</main>

<script>
const stateMapFull = {
  AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas",
  CA: "California", CO: "Colorado", CT: "Connecticut", DE: "Delaware",
  FL: "Florida", GA: "Georgia", HI: "Hawaii", ID: "Idaho", IL: "Illinois",
  IN: "Indiana", IA: "Iowa", KS: "Kansas", KY: "Kentucky", LA: "Louisiana",
  ME: "Maine", MD: "Maryland", MA: "Massachusetts", MI: "Michigan",
  MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
  NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey",
  NM: "New Mexico", NY: "New York", NC: "North Carolina", ND: "North Dakota",
  OH: "Ohio", OK: "Oklahoma", OR: "Oregon", PA: "Pennsylvania",
  RI: "Rhode Island", SC: "South Carolina", SD: "South Dakota",
  TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
  VA: "Virginia", WA: "Washington", WV: "West Virginia",
  WI: "Wisconsin", WY: "Wyoming", DC: "District of Columbia"
};

let selectedState = null;

/* Populate dropdown once */
const dropdown = document.getElementById("stateDropdown");
dropdown.innerHTML = Object.entries(stateMapFull)
  .map(([code, name]) => `<div data-code="${code}">${name}</div>`)
  .join("");

async function detectUserState() {
  try {
    const res = await fetch("https://ipinfo.io/json?token=c0053c34b2bf22");
    const info = await res.json();

    if (info.region_code) return info.region_code.toUpperCase();

    const region = (info.region || "").toUpperCase();
    const found = Object.keys(stateMapFull).find(
      abbr => stateMapFull[abbr].toUpperCase() === region
    );
    return found || null;
  } catch {
    return null;
  }
}

async function loadFlagStatus(forcedState = null) {
  const userState = await detectUserState();
  const state = (forcedState || userState || "VA").toUpperCase();
  selectedState = state;

  const res = await fetch(`/.netlify/functions/getFlagStatus?state=${state}`);
  const data = await res.json();

  const national = data.find(r => r.state_code === null);
  const stateRow = data.find(r => (r.state_code || "").toUpperCase() === state);

  const usHalf = national?.half_mast;
  const stateHalf = stateRow?.half_mast;

  const usWrap = document.getElementById("us-flag").closest(".flag-wrapper");
  const stWrap = document.getElementById("state-flag").closest(".flag-wrapper");

  document.getElementById("us-flag").src = "/FlagIcons/USAFlag.png";
  document.getElementById("state-flag").src = `/FlagIcons/${state}Flag.png`;

  usWrap.classList.toggle("half-mast", usHalf);
  stWrap.classList.toggle("half-mast", stateHalf);

  const footer = document.getElementById("statusText");
  const stateName = stateMapFull[state];

  if (usHalf && stateHalf) {
    const reason = stateRow?.reason || national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (!usHalf && stateHalf) {
    const reason = stateRow?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are not at half mast<br>
      <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (usHalf && !stateHalf) {
    const reason = national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are at half mast for ${reason}.<br>
      <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  } else {
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  }
}

/* Dropdown logic */
document.addEventListener("click", (e) => {
  const dropdown = document.getElementById("stateDropdown");
  const main = document.querySelector("main");

  const isSelectableState = e.target.classList.contains("selectable-state");
  const isOpen = !dropdown.classList.contains("hidden");

  if (isSelectableState) {
    if (isOpen) {
      dropdown.classList.add("hidden");
      return;
    }

    dropdown.classList.remove("hidden");
    const dropdownHeight = dropdown.offsetHeight;

    const rect = e.target.getBoundingClientRect();
    const mainRect = main.getBoundingClientRect();

    let topPos = (rect.top - mainRect.top - dropdownHeight - 10);

    if (topPos < 0) {
       topPos = (rect.bottom - mainRect.top + 10);
    }

    dropdown.style.top = topPos + "px";
    dropdown.style.left = (rect.left - mainRect.left) + "px";

    return;
  }

  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

/* Dropdown select */
dropdown.addEventListener("click", (e) => {
  if (!e.target.dataset.code) return;
  const newState = e.target.dataset.code;
  dropdown.classList.add("hidden");
  loadFlagStatus(newState);
});

loadFlagStatus();
</script>

</body>
</html>
