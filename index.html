<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flag Status</title>

<style>
body {
  font-family: "Georgia", serif;
  background-color: #fff;
  color: #000;
  text-align: center;
  margin: 0;
  padding: 0;
  background-image: url("FlagIcons/skyline.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center top;
  background-attachment: fixed;
}

header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 20px 40px;
  font-weight: bold;
  font-size: 1.2rem;
}

header img {
  height: 22px;
  margin-right: 8px;
}

main {
  /* Retain top margin, but remove margin-left as positioning will be absolute/fixed */
  margin-top: 275px; 
  /* Add relative positioning to keep the absolute flag container relative to this area */
  position: relative;
  /* Ensure main takes up the necessary width for the footer text to center */
  width: 100%; 
}

.flag-container {
  /* FIX 1: Absolute positioning to fix flags to the background image's sidewalk */
  position: absolute;
  top: 0; /* Aligns container top with main margin-top (275px from body top) */
  left: 50%; /* Start in the middle */
  transform: translateX(-50%); /* Center the container based on its own width */
  width: 480px; /* Approximate width needed to contain the two poles and gap (200+80+200) */
  
  display: flex;
  /* Center the poles within the new fixed width container */
  justify-content: center; 
  align-items: center;
  gap: 80px; 
  margin-bottom: 30px;
  background-color: transparent;
  z-index: 2;
}

.flag-pole {
  position: relative;
  width: 200px;
  height: 350px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  background-color: transparent;
  z-index: 1;
}

.flag-wrapper {
  position: absolute;
  /* FIX 2: Correct full-mast position */
  top: 15px; 
  left: 15px;
  transition: top 2.2s ease-in-out;
  z-index: 2;
}

.flag-wrapper.half-mast {
  /* FIX 2: Correct half-mast position */
  top: 80px;
}

.flag-pole > img {
  max-height: 100%;
  object-fit: contain;
  width: auto;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}

.flag-wrapper img {
  height: 150px;
  width: auto;
  object-fit: contain;
  position: relative;
  z-index: 2;
  left: 0;
}

/* Clickable state text INSIDE the message */
.selectable-state {
  text-decoration: underline;
  cursor: pointer;
  font-weight: bold;
}

/* Dropdown */
.state-dropdown {
  position: absolute;
  background: #fff;
  border: 2px solid #000;
  padding: 12px;
  margin-top: 4px;
  width: 260px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 999;
  font-family: Georgia, serif;
  font-size: 1.1rem;
  line-height: 1.6;
}

.state-dropdown div {
  padding: 6px 4px;
  cursor: pointer;
  border-bottom: 1px solid #ccc;
}

.state-dropdown div:last-child {
  border-bottom: none;
}

.state-dropdown div:hover {
  background-color: #eee;
}

.hidden {
  display: none;
}

footer {
  font-size: 1.4rem;
  font-weight: bold;
  /* Ensure footer content is centered relative to the whole page */
  text-align: center;
  margin-top: 400px; /* Push the footer down below the absolutely positioned flags */
}

footer em {
  font-style: italic;
  color: #444;
}

/* Suggested Responsiveness Update */
@media (max-width: 800px) {
  main {
    margin-top: 150px; 
  }

  .flag-container {
    width: 380px; /* Adjust container width for smaller screens */
    gap: 30px; /* Reduce gap between flags */
  }

  .flag-pole {
    width: 175px;
    height: 300px; 
  }

  .flag-wrapper img {
    height: 120px; 
  }
  
  .flag-wrapper.half-mast {
    top: 60px; /* Adjusted half-mast for new pole height */
  }

  footer {
    margin-top: 350px;
  }
}
</style>
</head>
<body>

<header>
  <img src="/FlagIcons/USAFlag.png" alt="Flag Icon" />
  Flag Status
</header>

<main>
  <div class="flag-container">
    <div class="flag-pole">
      <img id="us-pole" src="/FlagIcons/FlagPole.png" alt="U.S. Flagpole" />
      <div class="flag-wrapper">
        <img id="us-flag" src="/FlagIcons/USAFlag.png" alt="U.S. Flag" />
      </div>
    </div>

    <div class="flag-pole">
      <img id="state-pole" src="/FlagIcons/FlagPole.png" alt="State Flagpole" />
      <div class="flag-wrapper">
        <img id="state-flag" src="/FlagIcons/VAFlag.png" alt="State Flag" />
      </div>
    </div>
  </div>

  <footer id="statusText"></footer>

  <div id="stateDropdown" class="state-dropdown hidden"></div>
</main>

<script>
const stateMapFull = {
  AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas",
  CA: "California", CO: "Colorado", CT: "Connecticut", DE: "Delaware",
  FL: "Florida", GA: "Georgia", HI: "Hawaii", ID: "Idaho", IL: "Illinois",
  IN: "Indiana", IA: "Iowa", KS: "Kansas", KY: "Kentucky", LA: "Louisiana",
  ME: "Maine", MD: "Maryland", MA: "Massachusetts", MI: "Michigan",
  MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
  NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey",
  NM: "New Mexico", NY: "New York", NC: "North Carolina", ND: "North Dakota",
  OH: "Ohio", OK: "Oklahoma", OR: "Oregon", PA: "Pennsylvania",
  RI: "Rhode Island", SC: "South Carolina", SD: "South Dakota",
  TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
  VA: "Virginia", WA: "Washington", WV: "West Virginia",
  WI: "Wisconsin", WY: "Wyoming", DC: "District of Columbia"
};

let selectedState = null;

/* Populate dropdown once */
const dropdown = document.getElementById("stateDropdown");
dropdown.innerHTML = Object.entries(stateMapFull)
  .map(([code, name]) => `<div data-code="${code}">${name}</div>`)
  .join("");

async function detectUserState() {
  try {
    const res = await fetch("https://ipinfo.io/json?token=c0053c34b2bf22");
    const info = await res.json();

    if (info.region_code) return info.region_code.toUpperCase();

    const region = (info.region || "").toUpperCase();
    const map = stateMapFull;
    const found = Object.keys(map).find(
      abbr => map[abbr].toUpperCase() === region
    );

    return found || null;
  } catch {
    return null;
  }
}

async function loadFlagStatus(forcedState = null) {
  const userState = await detectUserState();
  const state = (forcedState || userState || "VA").toUpperCase();
  selectedState = state;

  const res = await fetch(`/.netlify/functions/getFlagStatus?state=${state}`);
  const data = await res.json();

  const national = data.find(r => r.state_code === null);
  const stateRow = data.find(r => (r.state_code || "").toUpperCase() === state);

  const usHalf = national?.half_mast;
  const stateHalf = stateRow?.half_mast;

  const usFlag = document.getElementById("us-flag");
  const stFlag = document.getElementById("state-flag");

  const usWrap = usFlag.closest(".flag-wrapper");
  const stWrap = stFlag.closest(".flag-wrapper");

  usFlag.src = "/FlagIcons/USAFlag.png";
  stFlag.src = `/FlagIcons/${state}Flag.png`;

  if (usHalf) usWrap.classList.add("half-mast");
  else usWrap.classList.remove("half-mast");

  if (stateHalf) stWrap.classList.add("half-mast");
  else stWrap.classList.remove("half-mast");

  const footer = document.getElementById("statusText");
  const stateName = stateMapFull[state];

  if (usHalf && stateHalf) {
    const reason = stateRow?.reason || national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (!usHalf && stateHalf) {
    const reason = stateRow?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are not at half mast<br>
      <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (usHalf && !stateHalf) {
    const reason = national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are at half mast for ${reason}.<br>
      <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  } else {
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  }
}

/* Dropdown positioning */
document.addEventListener("click", (e) => {
  const dropdown = document.getElementById("stateDropdown");

  if (e.target.classList.contains("selectable-state")) {
    const rect = e.target.getBoundingClientRect();
    
    // Temporarily remove hidden class to measure height
    dropdown.classList.remove("hidden"); 
    const dropdownHeight = dropdown.offsetHeight;
    
    // FIX 3: Dynamic positioning: rect.top (top of the text) - dropdownHeight - 10px (for spacing above the text).
    dropdown.style.top = (rect.top - dropdownHeight - 10) + "px"; 
    dropdown.style.left = rect.left + "px";

    // Toggle back (it's already removed, so this will show/hide correctly)
    dropdown.classList.toggle("hidden"); 
    return;
  }

  if (!dropdown.contains(e.target)) dropdown.classList.add("hidden");
});

/* Handle dropdown click */
dropdown.addEventListener("click", (e) => {
  if (!e.target.dataset.code) return;

  const newState = e.target.dataset.code;
  dropdown.classList.add("hidden");
  loadFlagStatus(newState);
});

loadFlagStatus();
</script>

</body>
</html>
