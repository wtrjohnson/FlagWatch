<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flag Status</title>

<style>
body {
  font-family: "Georgia", serif;
  background-color: #fff;
  color: #000;
  text-align: center;
  margin: 0;
  padding: 0;
  background-image: url("FlagIcons/skyline.png");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center top;
  background-attachment: fixed;
}

header {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 20px 40px;
  font-weight: bold;
  font-size: 1.2rem;
}

header img {
  height: 22px;
  margin-right: 8px;
}

main {
  /* INSTRUCTION FOR STEP 3: To raise the poles, DECREASE this value (e.g., change 275px to 150px) */
  margin-top: 150px; 
  position: relative;
  width: 100%; 
}

.flag-container {
  /* Absolute positioning to keep flags fixed relative to the background/main */
  position: absolute;
  top: 0; 
  left: 50%; 
  transform: translateX(-50%); 
  
  display: flex;
  justify-content: center; 
  align-items: center;
  gap: 80px; 
  background-color: transparent;
  z-index: 2;
  
  max-width: 100%;
  
  /* FIX FOR STEP 2: Allows clicks to pass through the empty space around flags 
     so they can reach the State button/footer below. */
  pointer-events: none;
}

.flag-pole {
  position: relative;
  width: 200px;
  height: 350px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  background-color: transparent;
  z-index: 1;
  /* Re-enable clicks on the poles themselves if needed */
  pointer-events: auto;
}

.flag-wrapper {
  position: absolute;
  top: 15px; 
  left: 15px;
  transition: top 2.2s ease-in-out;
  z-index: 2;
  pointer-events: auto;
}

.flag-wrapper.half-mast {
  top: 80px;
}

.flag-pole > img {
  max-height: 100%;
  object-fit: contain;
  width: auto;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}

.flag-wrapper img {
  height: 150px;
  width: auto;
  object-fit: contain;
  position: relative;
  z-index: 2;
  left: 0;
}

/* Clickable state text INSIDE the message */
.selectable-state {
  text-decoration: underline;
  cursor: pointer;
  font-weight: bold;
  position: relative; /* Helps with z-indexing context if needed */
  z-index: 10;
}

/* Dropdown */
.state-dropdown {
  position: absolute;
  background: #fff;
  border: 2px solid #000;
  padding: 12px;
  /* top/left set by JS */
  width: 260px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999; 
  font-family: Georgia, serif;
  font-size: 1.1rem;
  line-height: 1.6;
  text-align: left;
  /* Ensure the dropdown itself is clickable */
  pointer-events: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.state-dropdown div {
  padding: 6px 4px;
  cursor: pointer;
  border-bottom: 1px solid #ccc;
}

.state-dropdown div:last-child {
  border-bottom: none;
}

.state-dropdown div:hover {
  background-color: #eee;
}

.hidden {
  display: none;
}

footer {
  font-size: 1.4rem;
  font-weight: bold;
  text-align: center;
  /* INSTRUCTION FOR STEP 1: To lower the message, INCREASE this value (e.g., change 380px to 450px) */
  margin-top: 380px; 
  padding-bottom: 40px;
  position: relative;
  z-index: 5; /* Ensures text sits above background elements */
}

footer em {
  font-style: italic;
  color: #444;
}

/* Responsiveness Update */
@media (max-width: 800px) {
  main {
    /* Mobile instruction: adjust this if needed for mobile layout */
    margin-top: 150px; 
  }

  .flag-container {
    gap: 20px; 
  }

  .flag-pole {
    width: 150px; 
    height: 260px; 
  }

  .flag-wrapper img {
    height: 110px; 
  }
  
  .flag-wrapper {
    top: 10px;
    left: 10px;
  }
  
  .flag-wrapper.half-mast {
    top: 60px;
  }

  footer {
    margin-top: 290px;
    font-size: 1.1rem;
    padding: 0 10px;
  }
}
</style>
</head>
<body>

<header>
  <img src="/FlagIcons/USAFlag.png" alt="Flag Icon" />
  Flag Status
</header>

<main>
  <div class="flag-container">
    <div class="flag-pole">
      <img id="us-pole" src="/FlagIcons/FlagPole.png" alt="U.S. Flagpole" />
      <div class="flag-wrapper">
        <img id="us-flag" src="/FlagIcons/USAFlag.png" alt="U.S. Flag" />
      </div>
    </div>

    <div class="flag-pole">
      <img id="state-pole" src="/FlagIcons/FlagPole.png" alt="State Flagpole" />
      <div class="flag-wrapper">
        <img id="state-flag" src="/FlagIcons/VAFlag.png" alt="State Flag" />
      </div>
    </div>
  </div>

  <footer id="statusText"></footer>

  <div id="stateDropdown" class="state-dropdown hidden"></div>
</main>

<script>
const stateMapFull = {
  AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas",
  CA: "California", CO: "Colorado", CT: "Connecticut", DE: "Delaware",
  FL: "Florida", GA: "Georgia", HI: "Hawaii", ID: "Idaho", IL: "Illinois",
  IN: "Indiana", IA: "Iowa", KS: "Kansas", KY: "Kentucky", LA: "Louisiana",
  ME: "Maine", MD: "Maryland", MA: "Massachusetts", MI: "Michigan",
  MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
  NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey",
  NM: "New Mexico", NY: "New York", NC: "North Carolina", ND: "North Dakota",
  OH: "Ohio", OK: "Oklahoma", OR: "Oregon", PA: "Pennsylvania",
  RI: "Rhode Island", SC: "South Carolina", SD: "South Dakota",
  TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
  VA: "Virginia", WA: "Washington", WV: "West Virginia",
  WI: "Wisconsin", WY: "Wyoming", DC: "District of Columbia"
};

let selectedState = null;

/* Populate dropdown once */
const dropdown = document.getElementById("stateDropdown");
dropdown.innerHTML = Object.entries(stateMapFull)
  .map(([code, name]) => `<div data-code="${code}">${name}</div>`)
  .join("");

async function detectUserState() {
  try {
    const res = await fetch("https://ipinfo.io/json?token=c0053c34b2bf22");
    const info = await res.json();

    if (info.region_code) return info.region_code.toUpperCase();

    const region = (info.region || "").toUpperCase();
    const map = stateMapFull;
    const found = Object.keys(map).find(
      abbr => map[abbr].toUpperCase() === region
    );

    return found || null;
  } catch {
    return null;
  }
}

async function loadFlagStatus(forcedState = null) {
  const userState = await detectUserState();
  const state = (forcedState || userState || "VA").toUpperCase();
  selectedState = state;

  const res = await fetch(`/.netlify/functions/getFlagStatus?state=${state}`);
  const data = await res.json();

  const national = data.find(r => r.state_code === null);
  const stateRow = data.find(r => (r.state_code || "").toUpperCase() === state);

  const usHalf = national?.half_mast;
  const stateHalf = stateRow?.half_mast;

  const usFlag = document.getElementById("us-flag");
  const stFlag = document.getElementById("state-flag");

  const usWrap = usFlag.closest(".flag-wrapper");
  const stWrap = stFlag.closest(".flag-wrapper");

  usFlag.src = "/FlagIcons/USAFlag.png";
  stFlag.src = `/FlagIcons/${state}Flag.png`;

  if (usHalf) usWrap.classList.add("half-mast");
  else usWrap.classList.remove("half-mast");

  if (stateHalf) stWrap.classList.add("half-mast");
  else stWrap.classList.remove("half-mast");

  const footer = document.getElementById("statusText");
  const stateName = stateMapFull[state];

  if (usHalf && stateHalf) {
    const reason = stateRow?.reason || national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (!usHalf && stateHalf) {
    const reason = stateRow?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are not at half mast<br>
      <span class="selectable-state">${stateName}</span> flags are at half mast for ${reason}.
    `;
  } else if (usHalf && !stateHalf) {
    const reason = national?.reason || "an active proclamation";
    footer.innerHTML = `
      United States flags are at half mast for ${reason}.<br>
      <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  } else {
    footer.innerHTML = `
      United States and <span class="selectable-state">${stateName}</span> flags are not at half mast.
    `;
  }
}

/* Dropdown positioning and toggle logic */
document.addEventListener("click", (e) => {
  const dropdown = document.getElementById("stateDropdown");
  const main = document.querySelector("main");
  
  const isSelectableState = e.target.classList.contains("selectable-state");
  const isDropdownOpen = !dropdown.classList.contains("hidden");

  if (isSelectableState) {
    // If it's already open, just close it and return
    if (isDropdownOpen) {
      dropdown.classList.add("hidden");
      return;
    }
    
    // Otherwise, calculate position and open it
    dropdown.classList.remove("hidden"); // Temporarily show to measure height
    const dropdownHeight = dropdown.offsetHeight;
    
    const rect = e.target.getBoundingClientRect(); // Viewport coordinates of text
    const mainRect = main.getBoundingClientRect(); // Viewport coordinates of main container
    
    // Calculate initial top position (above the text)
    let topPos = (rect.top - mainRect.top - dropdownHeight - 10);
    
    // FIX FOR STEP 2: Smart Positioning
    // If the calculation places the dropdown off the top of the container/screen,
    // position it BELOW the text instead.
    if (topPos < 0) {
       topPos = (rect.bottom - mainRect.top + 10);
    }
    
    dropdown.style.top = topPos + "px"; 
    
    // Center logic or left align logic
    // Just keeping original left align logic relative to text start
    dropdown.style.left = (rect.left - mainRect.left) + "px";
    
    return;
  }

  // Hide the dropdown if the click was not on the dropdown itself
  if (!dropdown.contains(e.target)) {
    dropdown.classList.add("hidden");
  }
});

/* Handle dropdown selection click */
dropdown.addEventListener("click", (e) => {
  if (!e.target.dataset.code) return;

  const newState = e.target.dataset.code;
  dropdown.classList.add("hidden");
  loadFlagStatus(newState);
});

loadFlagStatus();
</script>

</body>
</html>
